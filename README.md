# Flipkart Offer API Backend

## Overview
A FastAPI backend to parse Flipkart offer responses, store unique offers, and compute the highest discount for a given payment scenario. Uses SQLite (easy to swap to PostgreSQL) and SQLAlchemy ORM.

## Project Structure
```
project/
│
├── app/
│   ├── main.py               # FastAPI app startup
│   ├── models.py             # SQLAlchemy models
│   ├── database.py           # DB engine and session setup
│   ├── schemas.py            # Pydantic request/response models
│   ├── crud.py               # DB insert/query logic
│   ├── utils.py              # Offer parsing logic
│   └── routes/
│       └── offers.py         # API endpoints
│
├── tests/
│   └── test_offers.py
│
├── requirements.txt
└── README.md
```

## Setup
1. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```
2. Run the app:
   ```bash
   uvicorn app.main:app --reload
   ```

## API Endpoints
### POST /offer
- Accepts Flipkart offer API response JSON.
- Extracts and stores unique offers.
- Request:
  ```json
  {
    "flipkartOfferApiResponse": {
      "data": {
        "paymentOffers": [
          {
            "bankName": "AXIS",
            "title": "10% off with Axis Bank Credit Cards",
            "offerType": "PERCENT",
            "discountValue": 10,
            "maxDiscount": 500,
            "paymentInstruments": ["CREDIT", "EMI_OPTIONS"]
          },
          {
            "bankName": "HDFC",
            "title": "Flat ₹200 off with HDFC Debit Cards",
            "offerType": "FLAT",
            "discountValue": 200,
            "maxDiscount": null,
            "paymentInstruments": ["DEBIT"]
          }
        ]
      }
    }
  }
  ```
- Response:
  ```json
  {
    "noOfOffersIdentified": 2,
    "noOfNewOffersCreated": 2
  }
  ```
- Example curl:
  ```bash
  curl -X POST "http://localhost:8000/offer" \
    -H "Content-Type: application/json" \
    -d '{
      "flipkartOfferApiResponse": {
        "data": {
          "paymentOffers": [
            {"bankName": "AXIS", "title": "10% off with Axis Bank Credit Cards", "offerType": "PERCENT", "discountValue": 10, "maxDiscount": 500, "paymentInstruments": ["CREDIT", "EMI_OPTIONS"]},
            {"bankName": "HDFC", "title": "Flat ₹200 off with HDFC Debit Cards", "offerType": "FLAT", "discountValue": 200, "maxDiscount": null, "paymentInstruments": ["DEBIT"]}
          ]
        }
      }
    }'
  ```

### GET /highest-discount
- Query params: `amountToPay`, `bankName`, optional `paymentInstrument`
- Returns the highest discount for the given scenario.
- Example:
  ```http
  GET /highest-discount?amountToPay=10000&bankName=AXIS&paymentInstrument=CREDIT
  ```
- Response:
  ```json
  { "highestDiscountAmount": 500 }
  ```
- Example curl:
  ```bash
  curl "http://localhost:8000/highest-discount?amountToPay=10000&bankName=AXIS&paymentInstrument=CREDIT"
  ```

## Testing
- Run tests with:
  ```bash
  pytest
  ```

## Scaling Notes
- For high QPS (1000+/sec):
  - Use PostgreSQL with indexes on `(bank_name, payment_instruments)`.
  - Add Redis caching for computed discounts by bank+amount+instrument.
  - Deploy behind a load balancer with auto-scaling backend pods (e.g., FastAPI + Gunicorn + Uvicorn workers).

## Improvements
- Add authentication for admin endpoints.
- Support offer expiry and update logic.
- Add more granular payment instrument support.
- Add OpenAPI docs (auto-generated by FastAPI at `/docs`).

## Note
- The offer parser in `app/utils.py` is currently set up for a mock Flipkart offer JSON structure. If the real Flipkart API response is different, update the parser accordingly.
